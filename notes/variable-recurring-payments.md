# Variable Recurring Payments - 1

## Use Case

 - **Coil** is an application that wishes to connect to Alice's Open Payments account
 - **Fynbos** is Alice's account provider
 - **Uphold** is Bob's account provider
 - **Alice** is an account holder at Fynbos and a user at Coil
 - **Bob** is an account holder at Uphold
 - Alice is visiting Bob's website and wishes to send Bob a tip. 
 - Bob has a Payment Pointer from Uphold that he has embedded on his website.
 - Alice has the Coil browser extension installed

### Out of Scope

- How does Fynbos verify Coil's identity as a client?
- How does Alice verify that the account she is tipping belongs to Bob?

### Step 1: Alice connects her Fynbos account to Coil

Alice wishes to give Coil the ability to send tips on her behalf from her Fynbos account.

Alice provides Coil with her Payment Pointer: `https://fynbos.me/alice`

Coil queries the Payment Pointer to get the grant request endpoint URL.

```http
GET /alice HTTP/1.1
Host: fynbos.me
Accept: application/op-account-v1+json
```

Fynbos responds:

```
HTTP/1.1 200 Success
Content-Type: application/op-alice-v1+json

{
    "id": "https://fynbos.me/alice",
    "publicName": "Alice"
    "assetCode": "USD",
    "assetScale": 2
    "authServer": "https://fynbos.dev/auth"
}
```

Coil makes a Grant Request to Fynbos at `https://fynbos.dev/auth`:

```json
{
    "access_token": {
        "access": [
            {
                "type": "outgoing-payment",
                "actions": [
                    "create", 
                    "authorize"
                ],
                "locations": [
                    "https://fynbos.me/alice"
                ]
            }
        ]
    },
    "client": {
        "display": {
            "name": "Coil",
            "uri": "https://coil.com"
        },
        "key": {
            "proof": "httpsig",
            "jwk": {
                "kty": "RSA",
                "e": "AQAB",
                "kid": "xyz-1",
                "alg": "RS256",
                "n": "kOB5rR4Jv0GMeL...."
            }
        }
    },
    "interact": {
        "start": [
            "redirect"
        ],
        "finish": {
            "method": "redirect",
            "uri": "https://coil.com/return/876FGRD8VC",
            "nonce": "LKLTI25DK82FX4T4QFZC"
        }
    }
}
```

Fynbos sends back an instruction to Coil to redirect Alice to a Fynbos web page to authenticate herself and consent to the grant request.

```json
{
    "interact": {
        "redirect": "https://fynbos.dev/auth/4CF492MLVMSW9MKMXKHQ",
        "finish": "MBDOFXG4Y5CVJCX821LH"
    },
    "continue": {
        "access_token": {
            "value": "80UPRY5NM33OMUKMKSKU"
        },
        "uri": "https://fynbos.dev/auth/continue"
    }
}
```

Coil directs Alice to `https://fynbos.dev/auth/4CF492MLVMSW9MKMXKHQ` which is a web page hosted by Fynbos.

Fynbos authenticates Alice and then prompts Alice to consent to giving Coil access to her account.

Fynbos allows Alice to specify a limit on what Coil will be able to do.

Example:
> Coil will be able to make payments from your account up to a total of $____ per ____.

Alice specifies $10 per month and Fynbos creates and records the new grant issued to Coil.

Fynbos redirects Alice to `https://coil.com/return/876FGRD8VC?hash=p28jsq0Y2KK3WS__a42tavNC64ldGTBroywsWxT4md_jZQ1R2HZT8BOWYHcLmObM7XHPAdJzTZMtKBsaraJ64A
  &interact_ref=4IFWWIKYBC2PQ6U56NL1`

> - The URL was provided by Coil in the grant request
> - The `interact_ref` is a random value generated by Fynbos
> - The `hash` was calculated by Fynbos based on:
>   - the > `nonce` Coil provided in the original request (`LKLTI25DK82FX4T4QFZC`), 
>   - the `nonce` Fynbos provided in the response (`MBDOFXG4Y5CVJCX821LH`)
>   - the `interact_ref`, and
>   - the URL of the grant request endpoint `https://fynbos.dev/auth`.

Coil validates the hash and then makes a continue request to Fynbos at `https://fynbos.dev/auth/continue` using the access token `80UPRY5NM33OMUKMKSKU`.

Fynbos responds to Coil with the following:

```json
{
    "access_token": {
        "value": "OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0",
        "manage": "https://fynbos.dev/auth/token/PRY5NM33OM4TB8N6BW7",
        "expires_in": 762534,
        "access": [
        {
            "type": "outgoing-payment",
            "actions": [
                "create", 
                "authorize",
            ],
            "locations": [
                "https://fynbos.me/alice"
            ],
            "grant": "PRY5NM33OM4TB8N6BW7",
            "startAt": "2022-02-03T18:25:43.511Z",
            "expiresAt": "2023-02-03T18:25:43.511Z",                
            "limits": {
                "monthly": {
                    "sendAmount": {
                        "amount": 1000, 
                    }
                },
            }
        }]
    },
    "continue": {
        "access_token": {
            "value": "YT98RY5NM33OMUKMK65U"
        },
        "uri": "https://fynbos.dev/auth/continue"
    }
}
```
Coil now has a grant to create and authorize outgoing payments from Alice's account up to a value of $10 per month.

### Step 2: Alice tips Bob through the Coil extension

Alice is on Bob's website and the Coil extension has parsed Bob's Payment Pointer from the page: `https://uphold.com/bob`

Alice wants to send a tip to Bob and clicks the "Tip" button on the extension. Alice elects to send $2 and provides a message of "Great blog bob!".

Coil creates the outgoing payment at Alice's Payment Pointer:

```http
POST /alice HTTP/1.1
Host: fynbos.me
Content-Type: application/op-outgoing-payment-v1+json
Accept: application/op-outgoing-payment-v1+json
Signature-Input: gnap=("@request-target" "host" "authorization");created=1624564850;keyid="xyz-client"
Signature: gnap=:EN/rExQ/knVi61P5AFhyMGN7aVPzk/9C7nsYAWF2RvzsoV1uNxGZklM55qCIQpuhoNty4EhiH7iwuzZBbRCQcQ==:
Authorization: GNAP OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0

{
    "state": "authorized",
    "receiver": "https://uphold.com/bob",
    "sendAmount": {
        "amount": 200,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Great blog bob!"
}
```

Within Fynbos the resource server (Rafiki) checks the grant associated with the provided token and gets the following response.

```json
{
    "active": true,
    "access": [
        {
            "type": "outgoing-payment",
            "actions": [
                "create"
                "authorize"
            ],
            "locations": [
                "https://fynbos.me/alice/"
            ],
            "grant": "PRY5NM33OM4TB8N6BW7",
            "startAt": "2022-02-03T18:25:43.511Z",
            "expiresAt": "2023-02-03T18:25:43.511Z",                
            "limits": {
                "monthly": {
                    "sendAmount": {
                        "amount": 1000, 
                    }
                },
            }
        }        
    ],
    "key": {
        "proof": "httpsig",
        "jwk": {
            "kty": "RSA",
            "e": "AQAB",
            "kid": "xyz-1",
            "alg": "RS256",
            "n": "kOB5rR4Jv0GMeL...."
        }
    },
}
```

The RS keeps balances for each time interval for every `grant`. 

Even though the AS confirms that this access token is valid, the RS may decline the client's request if the amount that it wants to send exceeds the limit per interval.

In this case, Fynbos has no record of any transactions using this grant in the current month so it starts a new balance to track these.

The balance of `PRY5NM33OM4TB8N6BW7_FEB_22` is $0 and will go up to $2 if this payment completes.

Fynbos has checked that Coil is authorised to create the payment. It returns a response:

```http
HTTP/1.1 201 Created
Content-Type: application/op-outgoing-payment-v1+json

{
    "id": "https://fynbos.me/alice/fi7td6dito8yf6t"
    "accountId": "https://fynbos.me/alice/",
    "state": "authorized",
    "sendAmount": {
        "amount": 200,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Great blog bob!"
    "receipts: []
}
```

Fynbos attempts to create an incoming payment at Bob's payment pointer to accept the payment.

> **TODO** This request should be authorised...

```http
POST /bob HTTP/1.1
Host: uphold.com
Content-Type: application/op-incoming-payment-v1+json
Accept: application/ilp-stream-v1+json
Receipt-Nonce: Cty6C+YB5X9FhSOUPCL
Receipt-Secret: asJeCty6C+YB5X9FhS

{
    "description": "Great blog bob!"
}
```

Uphold creates the incoming payment and returns the Interledger payment details.

```http
HTTP/1.1 201 Created
Content-Type: application/ilp-stream-v1+json

{
    "id": "https://uphold.com/bob/87tfi7td6dito8yf",
    "ilpAddress": "g.uphold.Cty6C+YB5X9FhSOUPCL",
    "sharedSecret": "6jR5iNIVRvqeasJeCty6C+YB5X9FhSOUPCL/5nha5Vs=",
    "receiptsEnabled": true
}
```

Fynbos opens a STREAM connection and starts sending until it has sent $2. It stores the latest receipt for each stream.

When Fynbos is finished sending it marks the payment complete:

```http
PUT /bob/87tfi7td6dito8yf HTTP/1.1
Host: uphold.com
Content-Type: application/op-incoming-payment-v1+json
Accept: application/op-incoming-payment-v1+json

{
    "status": "complete"
}
```

Uphold responds:

```http
HTTP/1.1 200 Success
Content-Type: application/op-incoming-payment-v1+json

{
    "id": "https://uphold.com/bob/87tfi7td6dito8yf",
    "accountId": "https://uphold.com/bob",
    "state": "completed",
    "receiver": "https://uphold.com/bob/87tfi7td6dito8yf",
    "receivedAmount": {
        "amount": 198,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Great blog bob!",
    "receipts": [
      {
        "nonce": "Cty6C+YB5X9FhSOUPCL",
        "stream": 0,
        "total": 198,
        "hmac": "6C+YB5X9FhSO3UPCCty6C+YB5X9FhSOUP5CL"
      }
    ]
}
```

At any time Coil polls the outgoing-payment for the latest state:

```http
GET /alice/fi7td6dito8yf6t HTTP/1.1
Host: fynbos.me
Accept: application/outgoing-payment-v1+json
```

The response includes the STREAM receipts that have been received by Fynbos.

A response that is received while the payment is in progress:

```http
HTTP/1.1 200 Success
Content-Type: application/op-outgoing-payment-v1+json
Cache-Control: no-cache

{
    "id": "https://fynbos.me/alice/fi7td6dito8yf6t",
    "accountId": "https://fynbos.me/alice/",
    "state": "authorized",
    "receiver": "https://uphold.com/bob/87tfi7td6dito8yf",
    "sendAmount": {
        "amount": 200,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Great blog bob!",
    "receipts": [
      {
        "nonce": "VR66CYB5X9FhSOUPCL",
        "stream": 0,
        "total": 73,
        "hmac": "9B025X9FhSO3UPCCty6C+YB5X9FhSOUP5CL"
      }
    ]
}
```

A response after the payment is completed:

```http
HTTP/1.1 200 Success
Content-Type: application/op-outgoing-payment-v1+json
Cache-Control: max-age=348756

{
    "id": "https://fynbos.me/alice/fi7td6dito8yf6t",
    "accountId": "https://fynbos.me/alice/",
    "state": "completed",
    "receiver": "https://uphold.com/bob/87tfi7td6dito8yf",
    "sendAmount": {
        "amount": 200,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Great blog bob!",
    "receipts": [
      {
        "nonce": "Cty6C+YB5X9FhSOUPCL",
        "stream": 0,
        "total": 198,
        "hmac": "6C+YB5X9FhSO3UPCCty6C+YB5X9FhSOUP5CL"
      }
    ]
}
```

### Edge Case: Alice tips Charly through the Coil extension and exceeds the $10 grant

Alice is on Charly's website and the Coil extension has parsed Charly's Payment Pointer from the page: `https://uphold.com/charly`

Alice wants to send a tip to Charly and clicks the "Tip" button on the extension. Alice elects to send $5 and provides a message of "Fantastic knowledge base, Charly!".

**Note that Alice has already tipped $7 over the course of the current month and the tip she wants to send will exceed the grant she gave to Coil.**

Coil creates the outgoing payment at Alice's Payment Pointer:

```http
POST /alice HTTP/1.1
Host: fynbos.me
Content-Type: application/op-outgoing-payment-v1+json
Accept: application/op-outgoing-payment-v1+json
Signature-Input: gnap=("@request-target" "host" "authorization");created=1624564850;keyid="xyz-client"
Signature: gnap=:EN/rExQ/knVi61P5AFhyMGN7aVPzk/9C7nsYAWF2RvzsoV1uNxGZklM55qCIQpuhoNty4EhiH7iwuzZBbRCQcQ==:
Authorization: GNAP OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0

{
    "state": "authorized",
    "receiver": "https://uphold.com/charly",
    "sendAmount": {
        "amount": 500,
        "assetCode": "USD",
        "assetScale": 2
    },
    "description": "Fantastic knowledge base, Charly!"
}
```

Within Fynbos the resource server (Rafiki) checks the grant associated with the provided token and gets the following response.

```json
{
    "active": true,
    "access": [
        {
            "type": "outgoing-payment",
            "actions": [
                "create"
                "authorize"
            ],
            "locations": [
                "https://fynbos.me/alice/"
            ],
            "grant": "PRY5NM33OM4TB8N6BW7",
            "startAt": "2022-02-03T18:25:43.511Z",
            "expiresAt": "2023-02-03T18:25:43.511Z",                
            "limits": {
                "monthly": {
                    "sendAmount": {
                        "amount": 1000, 
                    }
                },
            }
        }        
    ],
    "key": {
        "proof": "httpsig",
        "jwk": {
            "kty": "RSA",
            "e": "AQAB",
            "kid": "xyz-1",
            "alg": "RS256",
            "n": "kOB5rR4Jv0GMeL...."
        }
    },
}
```

The RS keeps balances for each time interval for every `grant`. 

Even though the AS confirms that this access token is valid, the RS declines the client's request because the amount that it wants to send exceeds the limit per interval. The balance of `PRY5NM33OM4TB8N6BW7_FEB_22` is $7.

Fynbos returns a response:

```http
HTTP/1.1 409 Conflict
Content-Type: application/op-outgoing-payment-v1+json

{
    "error": "Payment exceeds limit."
}
```

The Coil extension prompts Alice that the tip exceeds her monthly limit and that she needs to extend the grant. She agrees to that.

Coil continues its grant request with the AS

```http
POST auth/continue HTTP/1.1
Host: fynbos.dev
Content-Type: application/json
Authorization: GNAP YT98RY5NM33OMUKMK65U
Signature-Input: sig1=...
Signature: sig1=...
Digest: sha256=...

{
    "access_token": {
        "access": [
            {
                "type": "outgoing-payment",
                "actions": [
                    "create", 
                    "authorize"
                ],
                "locations": [
                    "https://fynbos.me/alice"
                ],
                "limits": {
                    "sendAmount": {
                        "amount": 1200,
                        "assetCode": "USD",
                        "assetScale": 2
                    }
                }
            }
        ]
    },
    "client": {
        "display": {
            "name": "Coil",
            "uri": "https://coil.com"
        },
        "key": {
            "proof": "httpsig",
            "jwk": {
                "kty": "RSA",
                "e": "AQAB",
                "kid": "xyz-1",
                "alg": "RS256",
                "n": "kOB5rR4Jv0GMeL...."
            }
        }
    },
    "interact": {
        "start": [
            "redirect"
        ],
        "finish": {
            "method": "redirect",
            "uri": "https://coil.com/return/876FGRD8VC",
            "nonce": "LKLTI25DK82FX4T4QFZC"
        }
    }
}
```

Fynbos sends back an instruction to Coil to redirect Alice to a Fynbos web page to authenticate herself and consent to the grant request.

```json
{
    "interact": {
        "redirect": "https://fynbos.dev/auth/HQ4CF492MLVMSW9MKMXK",
        "finish": "LHMBDOFXG4Y5CVJCX821"
    },
    "continue": {
        "access_token": {
            "value": "KU80UPRY5NM33OMUKMKS"
        },
        "uri": "https://fynbos.dev/auth/continue"
    }
}
```
Coil directs Alice to https://fynbos.dev/auth/HQ4CF492MLVMSW9MKMXK which is a web page hosted by Fynbos.

Fynbos authenticates Alice and then prompts Alice to consent to giving Coil access to her account wth the updated limit of $12 for the current month. She consents

Fynbos responds to Coil with the following:

```json
{
    "access_token": {
        "value": "T0OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1L",
        "manage": "https://fynbos.dev/auth/token/W7PRY5NM33OM4TB8N6B",
        "expires_in": 762534,
        "access": [
        {
            "type": "outgoing-payment",
            "actions": [
                "create", 
                "authorize",
            ],
            "locations": [
                "https://fynbos.me/alice"
            ],
            "grant": "PRY5NM33OM4TB8N6BW7",
            "startAt": "2022-02-03T18:25:43.511Z",
            "expiresAt": "2023-02-03T18:25:43.511Z",                
            "limits": {
                "sendAmount": {
                    "amount": 1200,
                    "assetCode": "USD",
                    "assetScale": 2
                },
                "interval": "P1M"
            }
        }]
    },
    "continue": {
        "access_token": {
            "value": "5UYT98RY5NM33OMUKMK6"
        },
        "uri": "https://fynbos.dev/auth/continue"
    }
}
```
Coil now has a grant to create and authorize outgoing payments from Alice's account up to a value of $12 for this month.

The rest of the flow is as described in [Step 2](#Step-2-Alice-tips-Bob-through-the-Coil-extension).